<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡å­—éº»å°†è”æœºç‰ˆ - æœ€ç»ˆç¨³å®šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mj-green: #1a472a; --tile-bg: #fff; --accent: #ffeb3b; }
        body { font-family: -apple-system, sans-serif; background: #111; color: white; margin: 0; padding: 10px; min-height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* çŠ¶æ€æ  */
        #conn-panel { background: #222; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #444; }
        .id-label { font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
        .id-text { color: var(--accent); font-family: monospace; font-weight: bold; word-break: break-all; font-size: 0.9rem; }
        
        /* å¼ƒç‰Œæ±  */
        #pool-area { height: 110px; background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 8px; padding: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 4px; overflow-y: auto; margin-bottom: 10px; }
        
        /* å¯¹æ–¹çŠ¶æ€ */
        .opponent-side { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; text-align: center; color: #888; font-size: 0.8rem; margin-bottom: 10px; border: 1px dashed #444; }
        .opponent-side.active { border-color: var(--accent); color: var(--accent); background: rgba(255,235,59,0.05); }

        /* è‡ªå·±åŒºåŸŸ */
        .my-side { background: #1e1e1e; border: 1px solid #444; padding: 12px; border-radius: 12px; flex: 1; display: flex; flex-direction: column; transition: 0.3s; }
        .my-side.active { background: var(--mj-green); border-color: var(--accent); box-shadow: 0 0 15px rgba(26,71,42,0.5); }

        .hand { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 20px 0; min-height: 55px; }
        .tile { 
            width: 38px; height: 52px; background: var(--tile-bg); color: #000; border-radius: 5px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: bold; 
            box-shadow: 0 4px #ccc; border: 2px solid transparent; user-select: none;
        }
        .tile.selected { border-color: #2196f3; transform: translateY(-10px); box-shadow: 0 8px 15px rgba(0,0,0,0.5); }
        .tile.pool-tile { width: 24px; height: 34px; font-size: 0.8rem; box-shadow: 0 1px #999; opacity: 0.8; }
        .tile.new { border-color: #ffa000; background: #fffde7; }

        .controls { display: flex; gap: 10px; }
        button { flex: 1; padding: 14px 0; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-draw { background: var(--accent); color: #000; }
        .btn-discard { background: #2196f3; color: white; }
        .btn-win { background: #f44336; color: white; flex: 0.4; }

        #vote-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="conn-panel">
        <div class="id-label">æˆ‘çš„ ID (ç‚¹å‡»å¯å¤åˆ¶):</div>
        <div class="id-text" id="my-id" onclick="copyId()">æ­£åœ¨è·å–ä¿¡å·...</div>
        <div id="connect-tools" style="margin-top:10px; display: flex; gap: 8px;">
            <input type="text" id="peer-id-input" placeholder="è¾“å…¥å¯¹æ‰‹ ID" style="flex:1; background:#000; color:#fff; border:1px solid #555; padding:8px; border-radius:5px;">
            <button onclick="connectToPeer()" style="width:auto; padding:0 15px; background:#444; color:#fff; font-size:0.9rem;">è¿æ¥</button>
        </div>
        <div id="status-msg" style="color: #6d6d6d; margin-top:6px; font-size:0.75rem;">æ­£åœ¨åˆå§‹åŒ–...</div>
        <button id="force-start" onclick="startGame()" style="display:none; margin-top:10px; background:#4caf50; color:white; padding:5px;">å¼ºåˆ¶å‘ç‰Œ/å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div id="opponent-info" class="opponent-side">ç­‰å¾…å¯¹æ‰‹è¿æ¥...</div>
    <div id="pool-area"></div>

    <div id="my-zone" class="my-side">
        <div id="role-tag" style="font-size:0.7rem; color: #888; text-transform: uppercase;">WATING...</div>
        <div class="hand" id="my-hand"></div>
        <div class="controls">
            <button class="btn-draw" id="btn-draw" onclick="doDraw()" disabled>æ‘¸ç‰Œ</button>
            <button class="btn-discard" id="btn-discard" onclick="doDiscard()" disabled>å‡ºç‰Œ/åƒç‰Œ</button>
            <button class="btn-win" id="btn-win" onclick="askWin()" disabled>èƒ¡ç‰Œ</button>
        </div>
    </div>

    <div id="vote-overlay">
        <div style="background:#2a2a2a; padding:25px; border-radius:15px; width:85%; text-align:center; border: 1px solid var(--accent);">
            <h3 style="margin-top:0">èƒ¡ç‰Œè¡¨å†³</h3>
            <div id="vote-content" style="font-size:1.8rem; color:var(--accent); margin:20px 0; letter-spacing:2px;"></div>
            <div style="display:flex; gap:10px;">
                <button style="background:#4caf50; color:white;" onclick="sendVote(true)">è®¤å¯ (Taèµ¢äº†)</button>
                <button style="background:#f44336; color:white;" onclick="sendVote(false)">åå¯¹ (ç»§ç»­æ‰“)</button>
            </div>
        </div>
    </div>

<script>
    const CHARS = "æˆ‘ä½ ä»–å¥¹å’±è°ä»¬å¤§å®¶çš„äººçš„äº†æ˜¯ä¸éƒ½åœ¨æœ‰æ²¡è¦ä¼šæƒ³çœ‹å¬å†™è®²è¯´æ‹¿èµ°è·‘å»ç©ç¬‘å“­çˆ±æ¨æ€•è¯·é—®è°¢å¯¹èµ·ç»™æ‰“æ‰¾ä¹°å–ç”¨å¼€å…³å°±æ‰åˆè¿˜ä¹Ÿåªå¾ˆæœ€çœŸå¤ªå¿«æ…¢å¤§ä¸­å°å¤šå¤šå°‘å¥½åç¾ä¸‘æ–°æ—§é•¿çŸ­é«˜çŸ®èƒ–ç˜¦é»‘ç™½çº¢ç»¿è“å¤©åœ°ä¸‹å±±æ°´èŠ±è‰é±¼è‚‰é¥­èœé…’æ°´è½¦ä¹¦ç¬”çº¸é’±å®¶æ ¡å‹æ‰‹".split("");
    let peer, conn, myRole = '', isMyTurn = false, hasActioned = false, firstIdx = -1;
    let myHand = [], discardPool = [], mainDeck = [];

    // 1. åˆå§‹åŒ– Peer
    peer = new Peer();
    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
        document.getElementById('status-msg').innerText = "ä¿¡å·å°±ç»ªï¼Œè¯·åˆ†äº« ID æˆ–è¿æ¥å¯¹æ‰‹";
    });

    peer.on('error', err => {
        document.getElementById('status-msg').innerText = "è¿æ¥æ•…éšœ: " + err.type;
        console.error(err);
    });

    // 2. æˆ¿ä¸»æ¥æ”¶è¿æ¥
    peer.on('connection', c => {
        conn = c; myRole = 'host'; setupConn();
    });

    // 3. è®¿å®¢è¿æ¥æˆ¿ä¸»
    function connectToPeer() {
        const tid = document.getElementById('peer-id-input').value.trim();
        if(!tid) return alert("è¯·è¾“å…¥å¯¹æ‰‹ ID");
        conn = peer.connect(tid);
        myRole = 'guest';
        setupConn();
    }

    function setupConn() {
        document.getElementById('status-msg').innerText = "å»ºç«‹é€šé“ä¸­...";
        conn.on('open', () => {
            document.getElementById('status-msg').innerText = "æ¡æ‰‹æˆåŠŸï¼å‡†å¤‡æ¸¸æˆ";
            document.getElementById('connect-tools').style.display = 'none';
            document.getElementById('role-tag').innerText = myRole === 'host' ? "æˆ‘æ˜¯: æˆ¿ä¸»" : "æˆ‘æ˜¯: è®¿å®¢";
            document.getElementById('force-start').style.display = 'block'; // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
            
            // è®¿å®¢è¿æ¥åç»™æˆ¿ä¸»å‘ä¸ªä¿¡å·
            if(myRole === 'guest') {
                setTimeout(() => conn.send({type: 'READY'}), 500);
            }
        });

        conn.on('data', data => handleData(data));
        conn.on('close', () => {
            alert("å¯¹æ–¹æ–­å¼€äº†è¿æ¥");
            location.reload();
        });
    }

    // 4. æ•°æ®åŒæ­¥é€»è¾‘
    function handleData(data) {
        console.log("æ”¶åˆ°ä¿¡å·:", data.type);
        switch(data.type) {
            case 'READY':
                if(myRole === 'host') startGame(); // æˆ¿ä¸»æ”¶åˆ°å‡†å¤‡ä¿¡å·ï¼Œå‘ç‰Œ
                break;
            case 'INIT':
                myHand = data.hand;
                discardPool = data.pool;
                isMyTurn = (data.turn === myRole);
                render();
                break;
            case 'OPP_DISCARD':
                discardPool.push(data.tile);
                isMyTurn = true;
                hasActioned = false;
                render();
                break;
            case 'VOTE_WIN':
                document.getElementById('vote-content').innerText = data.txt;
                document.getElementById('vote-overlay').style.display = 'flex';
                break;
            case 'VOTE_RES':
                if(data.ok) { alert("ğŸ‰ å¯¹æ–¹è®¤å¯äº†ï¼ä½ èµ¢äº†ï¼"); location.reload(); }
                else { alert("âŒ å¯¹æ–¹ä¸è®¤å¯ä½ çš„å¥å­ã€‚"); }
                break;
        }
    }

    // 5. æ¸¸æˆåŠ¨ä½œ
    function startGame() {
        mainDeck = [];
        // æ¯ç§å­—æ”¾ 2 å¼ 
        CHARS.forEach(c => { mainDeck.push(c); mainDeck.push(c); });
        mainDeck.sort(() => Math.random() - 0.5);
        
        const h1 = mainDeck.splice(0, 13);
        const h2 = mainDeck.splice(0, 13);
        
        myHand = h1;
        isMyTurn = true;
        
        conn.send({
            type: 'INIT',
            hand: h2,
            pool: [],
            turn: 'host'
        });
        document.getElementById('force-start').style.display = 'none';
        render();
    }

    function doDraw() {
        if(!isMyTurn || hasActioned) return;
        // ç®€å•é€»è¾‘ï¼šéšæœºä»è¯åº“æ‘¸ä¸€å¼ ï¼ˆä¿è¯è”æœºä¸ä¸­æ–­ï¼‰
        const t = CHARS[Math.floor(Math.random()*CHARS.length)];
        myHand.push(t);
        hasActioned = true;
        render();
    }

    function doDiscard() {
        if(!isMyTurn) return;
        // åƒç‰Œé€»è¾‘ï¼šå¦‚æœæ²¡æ‘¸ç‰Œç‚¹è¿™ä¸ªï¼Œå°±æ˜¯åƒæœ€åä¸€å¼ å¼ƒç‰Œ
        if(!hasActioned) {
            if(discardPool.length === 0) return alert("æ²¡æœ‰å¯ä»¥åƒçš„ç‰Œ");
            const last = discardPool.pop();
            myHand.push(last);
            hasActioned = true;
            render();
            return;
        }
        // å‡ºç‰Œé€»è¾‘
        if(firstIdx === -1) return alert("è¯·å…ˆç‚¹é€‰ä¸€å¼ ä½ è¦å‡ºçš„ç‰Œ");
        const t = myHand.splice(firstIdx, 1)[0];
        discardPool.push(t);
        conn.send({type: 'OPP_DISCARD', tile: t});
        isMyTurn = false;
        hasActioned = false;
        firstIdx = -1;
        render();
    }

    function askWin() {
        if(myHand.length !== 13) return alert("æ‰‹ç‰Œå¿…é¡»æ˜¯ 13 å¼ æ‰èƒ½èƒ¡ç‰Œï¼");
        conn.send({type: 'VOTE_WIN', txt: myHand.join("")});
    }

    function sendVote(ok) {
        document.getElementById('vote-overlay').style.display = 'none';
        conn.send({type: 'VOTE_RES', ok: ok});
        if(ok) location.reload();
    }

    function render() {
        const h = document.getElementById('my-hand');
        h.innerHTML = '';
        myHand.forEach((t, i) => {
            const el = document.createElement('div');
            el.className = `tile ${firstIdx === i ? 'selected' : ''}`;
            el.innerText = t;
            el.onclick = () => {
                if(isMyTurn) {
                    if(firstIdx === i) firstIdx = -1;
                    else firstIdx = i;
                    render();
                }
            };
            h.appendChild(el);
        });

        const p = document.getElementById('pool-area');
        p.innerHTML = '';
        discardPool.forEach(t => {
            const d = document.createElement('div');
            d.className = 'tile pool-tile';
            d.innerText = t;
            p.appendChild(d);
        });

        document.getElementById('my-zone').className = `my-side ${isMyTurn ? 'active' : ''}`;
        document.getElementById('opponent-info').innerText = isMyTurn ? "è½®åˆ°ä½ å‡ºç‰Œ" : "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...";
        document.getElementById('opponent-info').className = `opponent-side ${!isMyTurn ? 'active' : ''}`;
        
        document.getElementById('btn-draw').disabled = !isMyTurn || hasActioned;
        document.getElementById('btn-discard').disabled = !isMyTurn;
        document.getElementById('btn-win').disabled = !isMyTurn || myHand.length !== 13;
    }

    function copyId() {
        const id = document.getElementById('my-id').innerText;
        navigator.clipboard.writeText(id).then(() => {
            alert("ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¿«å‘ç»™å¯¹æ‰‹å§ï¼");
        });
    }
</script>
</body>
</html>
