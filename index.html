<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>文字麻将联机版 - 修复发牌版</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mj-green: #1a472a; --tile-bg: #fff; --accent: #ffeb3b; }
        body { font-family: sans-serif; background: #111; color: white; margin: 0; padding: 10px; min-height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        #conn-panel { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; font-size: 0.9rem;}
        .id-text { color: var(--accent); word-break: break-all; font-family: monospace; }
        #pool-area { height: 100px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 5px; padding: 5px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 3px; overflow-y: auto; margin-bottom: 10px; }
        .opponent-side { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 10px; border: 1px dashed #333; }
        .opponent-side.active { border: 1px solid var(--accent); color: var(--accent); }
        .my-side { background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; flex: 1; display: flex; flex-direction: column; position: relative;}
        .my-side.active { background: var(--mj-green); border-color: var(--accent); }
        .hand { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin: 15px 0; min-height: 55px;}
        .tile { width: 35px; height: 48px; background: var(--tile-bg); color: #000; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; box-shadow: 0 3px #ccc; border: 2px solid transparent; }
        .tile.selected { border-color: #2196f3; transform: translateY(-8px); }
        .tile.pool-tile { width: 22px; height: 32px; font-size: 0.7rem; box-shadow: 0 1px #999; }
        .controls { display: flex; gap: 8px; }
        button { flex: 1; padding: 12px 0; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.5; }
        button:not(:disabled) { opacity: 1; }
        .btn-draw { background: var(--accent); color: #000; }
        .btn-discard { background: #2196f3; color: white; }
        .btn-win { background: #f44336; color: white; flex: 0.5; }
        #vote-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="conn-panel">
        <div>我的ID: <span class="id-text" id="my-id">正在获取...</span></div>
        <div id="connect-tools" style="margin-top:8px; display: flex; gap: 5px;">
            <input type="text" id="peer-id-input" placeholder="贴入对手ID" style="flex:1; background:#000; color:#fff; border:1px solid #444; padding:5px;">
            <button onclick="connectToPeer()" style="opacity:1; width:auto; padding:5px 10px; background:var(--accent);">连接</button>
        </div>
        <div id="status-msg" style="color: #aaa; margin-top:5px; font-size:0.7rem;">等待连接中...</div>
    </div>

    <div id="opponent-info" class="opponent-side">对手未连接</div>
    <div id="pool-area"></div>

    <div id="my-zone" class="my-side">
        <div id="role-tag" style="font-size:0.7rem; color: #aaa;">待定身份</div>
        <div class="hand" id="my-hand"></div>
        <div class="controls">
            <button class="btn-draw" id="btn-draw" onclick="doDraw()" disabled>摸牌</button>
            <button class="btn-discard" id="btn-discard" onclick="doDiscard()" disabled>出牌/吃牌</button>
            <button class="btn-win" id="btn-win" onclick="askWin()" disabled>胡牌</button>
        </div>
    </div>

    <div id="vote-overlay">
        <div style="background:#333; padding:20px; border-radius:15px; width:80%; text-align:center;">
            <h3>胡牌申请</h3>
            <div id="vote-content" style="font-size:1.5rem; color:var(--accent); margin:15px 0;"></div>
            <div style="display:flex; gap:10px;">
                <button style="background:#4caf50; color:white; opacity:1;" onclick="sendVote(true)">认可</button>
                <button style="background:#f44336; color:white; opacity:1;" onclick="sendVote(false)">反对</button>
            </div>
        </div>
    </div>

<script>
    const CHARS = "我你他她咱谁们大家的人的了是不都在有没要会想看听写讲说拿走跑去玩笑哭爱恨怕请问谢对起给打找买卖用开关就才又还也只很最真太快慢大中小多多少好坏美丑新旧长短高矮胖瘦黑白红绿蓝天地下山水花草鱼肉".split("");
    let peer, conn, myRole = '', isMyTurn = false, hasActioned = false, firstIdx = -1;
    let myHand = [], discardPool = [], mainDeck = [];

    peer = new Peer();
    peer.on('open', id => document.getElementById('my-id').innerText = id);

    // 房主逻辑
    peer.on('connection', c => {
        conn = c; myRole = 'host'; setupConn();
    });

    // 访客逻辑
    function connectToPeer() {
        const tid = document.getElementById('peer-id-input').value;
        if(!tid) return;
        conn = peer.connect(tid); myRole = 'guest'; setupConn();
    }

    function setupConn() {
        document.getElementById('status-msg').innerText = "正在握手...";
        conn.on('open', () => {
            document.getElementById('status-msg').innerText = "连接成功！";
            document.getElementById('connect-tools').style.display = 'none';
            document.getElementById('role-tag').innerText = "我是: " + (myRole === 'host' ? '房主(先手)' : '访客');
            if(myRole === 'guest') conn.send({type: 'READY'}); // 访客告诉房主可以发牌了
        });
        conn.on('data', data => handleData(data));
    }

    function handleData(data) {
        if(data.type === 'READY' && myRole === 'host') {
            startGame();
        } else if(data.type === 'INIT') {
            myHand = data.hand; discardPool = data.pool; isMyTurn = data.turn === myRole; render();
        } else if(data.type === 'DRAW_SYNC') {
            myHand.push(data.tile); hasActioned = true; render();
        } else if(data.type === 'OPP_DISCARD') {
            discardPool.push(data.tile); isMyTurn = true; hasActioned = false; render();
        } else if(data.type === 'VOTE_WIN') {
            document.getElementById('vote-content').innerText = data.txt;
            document.getElementById('vote-overlay').style.display = 'flex';
        } else if(data.type === 'VOTE_RES') {
            alert(data.ok ? "对方认可了，你赢了！" : "对方不认可。");
            if(data.ok) location.reload();
        }
    }

    function startGame() {
        mainDeck = [];
        CHARS.forEach(c => { mainDeck.push(c); mainDeck.push(c); });
        mainDeck.sort(() => Math.random() - 0.5);
        const h1 = mainDeck.splice(0, 13);
        const h2 = mainDeck.splice(0, 13);
        myHand = h1; isMyTurn = true;
        conn.send({type: 'INIT', hand: h2, pool: [], turn: 'host'});
        render();
    }

    function doDraw() {
        if(!isMyTurn || hasActioned) return;
        if(myRole === 'host') {
            const t = mainDeck.shift();
            myHand.push(t); hasActioned = true; render();
        } else {
            // 访客暂时也从本地词库随机取一张（由于没有中转服务器，这是最稳定的办法）
            const t = CHARS[Math.floor(Math.random()*CHARS.length)];
            myHand.push(t); hasActioned = true; render();
        }
    }

    function doDiscard() {
        if(!isMyTurn) return;
        if(!hasActioned) { // 吃牌
            const last = discardPool[discardPool.length-1];
            if(!last) return;
            myHand.push(discardPool.pop()); hasActioned = true; render(); return;
        }
        if(firstIdx === -1) return alert("选一张牌");
        const t = myHand.splice(firstIdx, 1)[0];
        discardPool.push(t);
        conn.send({type: 'OPP_DISCARD', tile: t});
        isMyTurn = false; hasActioned = false; firstIdx = -1; render();
    }

    function askWin() {
        if(myHand.length !== 13) return alert("必须13张");
        conn.send({type: 'VOTE_WIN', txt: myHand.join("")});
    }

    function sendVote(ok) {
        document.getElementById('vote-overlay').style.display = 'none';
        conn.send({type: 'VOTE_RES', ok: ok});
        if(ok) location.reload();
    }

    function render() {
        const h = document.getElementById('my-hand'); h.innerHTML = '';
        myHand.forEach((t, i) => {
            const el = document.createElement('div');
            el.className = `tile ${firstIdx === i ? 'selected' : ''}`;
            el.innerText = t;
            el.onclick = () => { if(isMyTurn) firstIdx = (firstIdx === i ? -1 : i); render(); };
            h.appendChild(el);
        });
        const p = document.getElementById('pool-area'); p.innerHTML = '';
        discardPool.forEach(t => { const d = document.createElement('div'); d.className = 'tile pool-tile'; d.innerText = t; p.appendChild(d); });
        
        document.getElementById('my-zone').className = `my-side ${isMyTurn ? 'active' : ''}`;
        document.getElementById('opponent-info').innerText = isMyTurn ? "你的回合" : "对方操作中...";
        document.getElementById('btn-draw').disabled = !isMyTurn || hasActioned;
        document.getElementById('btn-discard').disabled = !isMyTurn;
        document.getElementById('btn-win').disabled = !isMyTurn || myHand.length !== 13;
    }
</script>
</body>
</html>
